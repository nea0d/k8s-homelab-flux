---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app coredns
  namespace: kube-system
spec:
  interval: 15m
  chart:
    spec:
      chart: *app
      version: 1.19.4
      sourceRef:
        kind: HelmRepository
        name: coredns-charts
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    image:
      repository: coredns/coredns
      tag: "1.9.3"
      pullPolicy: IfNotPresent
    # Create HorizontalPodAutoscaler object.
    replicaCount: 1
    # autoscaling:
    #   minReplicas: 1
    #   maxReplicas: 3
    #   metrics:
    #   - type: Resource
    #     resource:
    #       name: cpu
    #       targetAverageUtilization: 60
    #   - type: Resource
    #     resource:
    #       name: memory
    #       targetAverageUtilization: 60
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 128Mi
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 25%
    # prometheus:
    #   service:
    #     enabled: false
    #     annotations:
    #       prometheus.io/scrape: "true"
    #       prometheus.io/port: "9153"
    #   monitor:
    #     enabled: false
    #     additionalLabels: {}
    #     namespace: ""
    #     interval: ""

    # Default zone is what Kubernetes recommends:
    # https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/#coredns-configmap-options
    # servers:
    # - zones:
    #   - zone: .
    #   port: 53
    #   # If serviceType is nodePort you can specify nodePort here
    #   # nodePort: 30053
    #   plugins:
    #   - name: errors
    #   # Serves a /health endpoint on :8080, required for livenessProbe
    #   - name: health
    #     configBlock: |-
    #       lameduck 5s
    #   # Serves a /ready endpoint on :8181, required for readinessProbe
    #   - name: ready
    #   # Required to query kubernetes API for data
    #   - name: kubernetes
    #     parameters: cluster.local in-addr.arpa ip6.arpa
    #     configBlock: |-
    #       pods insecure
    #       fallthrough in-addr.arpa ip6.arpa
    #       ttl 30
    #   # Serves a /metrics endpoint on :9153, required for serviceMonitor
    #   - name: prometheus
    #     parameters: 0.0.0.0:9153
    #   - name: forward
    #     parameters: . /etc/resolv.conf
    #   - name: cache
    #     parameters: 30
    #   - name: loop
    #   - name: reload
    #   - name: loadbalance

    # Complete example with all the options:
    # - zones:                 # the `zones` block can be left out entirely, defaults to "."
    #   - zone: hello.world.   # optional, defaults to "."
    #     scheme: tls://       # optional, defaults to "" (which equals "dns://" in CoreDNS)
    #   - zone: foo.bar.
    #     scheme: dns://
    #     use_tcp: true        # set this parameter to optionally expose the port on tcp as well as udp for the DNS protocol
    #                          # Note that this will not work if you are also exposing tls or grpc on the same server
    #   port: 12345            # optional, defaults to "" (which equals 53 in CoreDNS)
    #   plugins:               # the plugins to use for this server block
    #   - name: kubernetes     # name of plugin, if used multiple times ensure that the plugin supports it!
    #     parameters: foo bar  # list of parameters after the plugin
    #     configBlock: |-      # if the plugin supports extra block style config, supply it here
    #       hello world
    #       foo bar
    tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
    # configure custom zone files as per https://coredns.io/2017/05/08/custom-dns-entries-for-kubernetes/
    zoneFiles: []
    #  - filename: example.db
    #    domain: example.com
    #    contents: |
    #      example.com.   IN SOA sns.dns.icann.com. noc.dns.icann.com. 2015082541 7200 3600 1209600 3600
    #      example.com.   IN NS  b.iana-servers.net.
    #      example.com.   IN NS  a.iana-servers.net.
    #      example.com.   IN A   192.168.99.102
    #      *.example.com. IN A   192.168.99.102
    ## Configue a cluster-proportional-autoscaler for coredns
    # See https://github.com/kubernetes-incubator/cluster-proportional-autoscaler
    autoscaler:
      # Enabled the cluster-proportional-autoscaler
      enabled: true
      # Number of cores in the cluster per coredns replica
      coresPerReplica: 256
      # Number of nodes in the cluster per coredns replica
      nodesPerReplica: 16
      # Min size of replicaCount
      min: 2
      # Max size of replicaCount (default of 0 is no max)
      max: 0
      # Whether to include unschedulable nodes in the nodes/cores calculations - this requires version 1.8.0+ of the autoscaler
      includeUnschedulableNodes: false
      # If true does not allow single points of failure to form
      preventSinglePointFailure: true
      image:
        repository: k8s.gcr.io/cpa/cluster-proportional-autoscaler
        tag: "1.8.6"
        pullPolicy: IfNotPresent
      tolerations:
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule
      resources:
        requests:
          cpu: "20m"
          memory: "10Mi"
        limits:
          cpu: "20m"
          memory: "10Mi"
