---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app minio-tenants
  namespace: storage
spec:
  interval: 15m
  chart:
    spec:
      # renovate: registryUrl=https://operator.min.io/
      chart: tenant
      version: 4.5.1
      sourceRef:
        kind: HelmRepository
        name: minio-charts
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  dependsOn:
    - name: minio-operator
      namespace: storage
  values:
    tenant:
      name: minio-tenant-main
      pools:
        - servers: 3
          volumesPerServer: 2
          name: pool-main
          storageClassName: nfs-k8s-storage
          size: 200Gi
      buckets:
        - name: "longhorn-backup"
          region: "us-east-1"
      prometheusOperator: false
      metrics:
        enabled: true
        port: 9000
        protocol: http
      certificate:
        requestAutoCert: false
      prometheus:
        diskCapacityGB: 1
        storageClassName: longhorn-temp
      log:
        db:
          volumeClaimTemplate:
            spec:
              storageClassName: longhorn-temp
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 1Gi
    ingress:
      console:
        enabled: true
        ingressClassName: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          hajimari.io/enable: "true"
          hajimari.io/icon: "bucket"
          hajimari.io/group: "storage"
          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
          traefik.ingress.kubernetes.io/router.middlewares: "networking-internal-only@kubernetescrd"
        host: &host-console "minio.${SECRET_PUBLIC_DOMAIN}"
        tls:
          - hosts:
              - *host-console
            secretName: "minio-console-tls"
      api:
        enabled: true
        ingressClassName: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          hajimari.io/enable: "true"
          hajimari.io/icon: "bucket"
          hajimari.io/group: "storage"
          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
          traefik.ingress.kubernetes.io/router.middlewares: "networking-internal-only@kubernetescrd"
        host: &host-api "s3.${SECRET_PUBLIC_DOMAIN}"
        tls:
          - hosts:
              - *host-api
            secretName: "minio-api-tls"
    secrets:
      name: minio-tenant-root
      accessKey: ${SECRET_MINIO_ROOT_USERNAME}
      secretKey: ${SECRET_MINIO_ROOT_PASSWORD}
