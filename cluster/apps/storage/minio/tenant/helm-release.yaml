---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app minio-tenants
  namespace: storage
spec:
  interval: 15m
  chart:
    spec:
      # renovate: registryUrl=https://operator.min.io/
      chart: tenant
      version: 4.5.4
      sourceRef:
        kind: HelmRepository
        name: minio-charts
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  dependsOn:
    - name: minio-operator
      namespace: storage
  values:
    tenant:
      name: minio-tenant-main
      pools:
        - servers: 3
          volumesPerServer: 2
          name: pool-main
          storageClassName: nfs-k8s-storage
          size: 200Gi
      buckets:
        - name: "longhorn-backup"
          region: "us-east-1"
        - name: "loki-chunks-v1"
          region: "us-east-1"
        - name: "postgres-backup-v1"
          region: "us-east-1"
      prometheusOperator: true
      configuration:
        name: minio-tenant-env-configuration
      # env:
      #   - name: MINIO_PROMETHEUS_AUTH_TYPE
      #     value: "public"
      #   - name: PROMETHEUS_NAMESPACE
      #     value: "monitoring"
      #   - name: MINIO_PROMETHEUS_URL
      #     value: http://kube-prometheus-stack-prometheus.monitoring:9090
      #   - name: MINIO_PROMETHEUS_JOB_ID
      #     value: minio-job
      #   - name: MINIO_BROWSER_REDIRECT_URL
      #     value: "https://minio.${SECRET_PUBLIC_DOMAIN}"
      #   - name: MINIO_SERVER_URL
      #     value: "https://s3.${SECRET_PUBLIC_DOMAIN}"
      #   - name: MINIO_ROOT_USER
      #     value: "${SECRET_MINIO_ROOT_USERNAME}"
      #   - name: MINIO_ROOT_PASSWORD
      #     value: "${SECRET_MINIO_ROOT_PASSWORD}"
      metrics:
        enabled: true
        port: 9000
        protocol: http
      certificate:
        requestAutoCert: false
      # prometheus:
        # diskCapacityGB: 1
        # storageClassName: longhorn-temp
      log:
        db:
          volumeClaimTemplate:
            spec:
              storageClassName: longhorn-temp
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 1Gi
    ingress:
      console:
        enabled: true
        ingressClassName: "nginx"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          hajimari.io/enable: "true"
          hajimari.io/icon: "bucket"
          hajimari.io/group: "storage"
        host: &host-console "minio.${SECRET_PUBLIC_DOMAIN}"
        tls:
          - hosts:
              - *host-console
            secretName: "minio-console-tls"
      api:
        enabled: true
        ingressClassName: "nginx"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          hajimari.io/enable: "true"
          hajimari.io/icon: "bucket"
          hajimari.io/group: "storage"
        host: &host-api "s3.${SECRET_PUBLIC_DOMAIN}"
        tls:
          - hosts:
              - *host-api
            secretName: "minio-api-tls"
    secrets:
      name: minio-tenant-root
      accessKey: ${SECRET_MINIO_ROOT_USERNAME}
      secretKey: ${SECRET_MINIO_ROOT_PASSWORD}
