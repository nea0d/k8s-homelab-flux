---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app qbittorrent
  namespace: nzb
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 0.1.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  maxHistory: 3
  values:
    image:
      repository: ghcr.io/onedr0p/qbittorrent
      tag: 4.4.3.1@sha256:cea2a1647727f49582ca3d517bc45d53d00abe211fc667c429020f042635ea34
    env:
      TZ: "${TIMEZONE}"
      QBITTORRENT__PORT: &port 8080
      QBITTORRENT__BT_PORT: &port-bt 16881
    hostname: *app
    podLabels:
      setGateway: "true"
    service:
      main:
        ports:
          http:
            port: *port
      bittorrent:
        enabled: true
        type: ClusterIP
        ports:
          bittorrent:
            enabled: true
            port: *port-bt
            protocol: TCP
            targetPort: *port-bt
    ingress:
      main:
        enabled: true
        ingressClassName: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
          traefik.ingress.kubernetes.io/router.middlewares: "networking-internal-only@kubernetescrd"
          hajimari.io/enable: "true"
          hajimari.io/icon: "cloud-download"
          hajimari.io/group: "nzb"
        hosts:
          - host: &host "{{ .Release.Name }}.${SECRET_PUBLIC_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - *host
            secretName: qbittorrent-tls
      api:
        enabled: true
        ingressClassName: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
          traefik.ingress.kubernetes.io/router.middlewares: "networking-internal-only@kubernetescrd"
        hosts:
          - host: *host
            paths:
              - path: /api
                pathType: Prefix
        tls:
          - hosts:
              - *host
            secretName: qbittorrent-api-tls
    persistence:
      config:
        enabled: true
        existingClaim: qbittorrent-config-v1
      media:
        enabled: true
        existingClaim: nfs-nas-media-pvc
    podSecurityContext:
      runAsUser: 568
      runAsGroup: 568
      fsGroup: 568
      fsGroupChangePolicy: "OnRootMismatch"
      supplementalGroups:
        - 100
    resources:
      requests:
        cpu: 10m
        memory: 250Mi
      limits:
        memory: 6000Mi
    addons:

      # -- The common chart supports adding a VPN add-on. It can be configured under this key.
      # For more info, check out [our docs](http://docs.k8s-at-home.com/our-helm-charts/common-library-add-ons/#wireguard-vpn)
      # @default -- See values.yaml
      vpn:
        # -- Enable running a VPN in the pod to route traffic through a VPN
        enabled: true

        # -- Specify the VPN type. Valid options are openvpn or wireguard
        type: openvpn

        # If the podSecurityContext is set to run as a different user, make sure to run the OpenVPN container as root.
        # This is required for it to be able to read certain configuration files.
        securityContext:
          runAsGroup: 0
          runAsUser: 0

        # -- OpenVPN specific configuration
        # @default -- See below
        openvpn:

          # -- Optionally specify an existing secret that contains the credentials.
          # Credentials should be stored under the `VPN_AUTH` key
          authSecret: vpn-auth-secret

        # -- All variables specified here will be added to the vpn sidecar container
        # See the documentation of the VPN image for all config values
        env:
          TZ: Europe/Paris
          WAIT_FOR_VPN: "true"
          FIREWALL: "on"
          ROUTE_1: "10.0.0.0/8"
          VPNPORT_1: "16881"
          OTHER_ARGS: "--mute-replay-warnings"

        # -- Reference an existing secret that contains the VPN configuration file
        # The chart expects it to be present under the `vpnConfigfile` key.
        configFileSecret: vpn-config-secret

        livenessProbe:
          exec:
            # In the example bellow the VPN output is outside FRANCE - change appropiatly
            command:
              - sh
              - -c
              - if [ $(wget -q -O- https://ipinfo.io/country) != 'FR' ]; then exit 0; else exit $?; fi
          # Initial delay before performing the probe
          initialDelaySeconds: 30
          # How often to perform the probe
          periodSeconds: 60
          # Timeout after which the probe times out
          timeoutSeconds: 5
          # Number of retry before restarting the pod
          failureThreshold: 3

        networkPolicy:
          enabled: true

          egress:
            - to:
                - ipBlock:
                    cidr: 0.0.0.0/0
              ports:
              # VPN traffic port - change if your provider uses a different port
                - port: 1194
                  protocol: UDP
              #- port: 16881
              #  protocol: TCP
              #- port: 16881
              #  protocol: UDP
            - to:
              # Allow traffic within K8S - change if your K8S cluster uses a different CIDR
                - ipBlock:
                    cidr: 10.0.0.0/8
